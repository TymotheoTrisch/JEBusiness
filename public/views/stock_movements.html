<!doctype html>
<html lang="pt-br">

<head>
  <meta charset="utf-8">
  <title>Movimentações de Estoque</title>
  {{csrf_meta}}
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    .container {
      max-width: 1300px;
      margin: 0 auto;
    }

    .toolbar {
      margin-bottom: 20px;
    }

    .btn {
      padding: 8px 15px;
      margin-right: 10px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      background: #007bff;
      color: white;
    }

    .btn-success {
      background: #28a745;
    }

    .btn-danger {
      background: #dc3545;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 8px;
    }

    th {
      background: #f2f2f2;
    }

    .modal {
      display: none;
      position: fixed;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
    }

    .modal.active {
      display: block;
    }

    .modal-content {
      background: #fff;
      margin: 5% auto;
      padding: 20px;
      width: 600px;
      border-radius: 4px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    input[type="text"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    textarea {
      resize: vertical;
      height: 80px;
    }


    /* Product select + info */
    .product-select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    .product-info {
      margin-top: 8px;
      padding: 10px;
      border-radius: 4px;
      background: #f9f9fb;
      border: 1px solid #eef0f5;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .product-info .title {
      font-weight: 700;
      color: #222;
    }

    .product-info .meta {
      color: #666;
      font-size: 13px;
    }

    /* Alerts - Melhorados */
    .alert {
      padding: 12px;
      margin-bottom: 20px;
      border-radius: 4px;
      animation: slideIn 0.3s ease-in-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .alert-success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .alert-danger {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .alert-info {
      background-color: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    /* Tags para Tipo de Movimentação */
    .movement-tag {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase
    }

    .tag-in {
      background: #e8f5ea;
      color: #1b7a2a;
      border: 1px solid #cfe9d0
    }

    .tag-out {
      background: #fff0f0;
      color: #8a1f2a;
      border: 1px solid #f4c6c6
    }

    .actions {
      display: flex;
      gap: 8px
    }

    .action-btn {
      padding: 6px 10px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 13px
    }

    .action-edit {
      background: #17a2b8;
      color: #fff
    }

    .action-delete {
      background: #e46060;
      color: #fff
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Movimentações de Estoque</h1>
    <div id="alerts"></div>
    <div class="toolbar">
      <button class="btn btn-success" onclick="openCreateModal()">+ Nova Movimentação</button>
      <button class="btn" onclick="loadMovements()">Atualizar</button>
      <a class="btn" href="/products">Voltar para Produtos</a>
    </div>

    <div id="movementsContainer">
      <div class="loading">Carregando movimentações...</div>
    </div>
  </div>

  <div id="movementModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h2 id="modalTitle">Nova Movimentação</h2>
      <div id="modalAlert"></div>
      <form id="movementForm">
        <input type="hidden" id="movementId">
        <div class="form-group">
          <label>Produto</label>
          <select id="movementProduct" class="product-select"></select>
          <div id="productInfo" class="product-info" style="display:none;">
            <div>
              <div class="title" id="productInfoName"></div>
              <div class="meta" id="productInfoId"></div>
              <div class="meta" id="productInfoCurrentStock"></div>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label>Quantidade</label>
          <input type="number" id="movementQuantity" min="1" value="1">
        </div>
        <div class="form-group">
          <label>Tipo</label>
          <select id="movementType">
            <option value="in">Entrada</option>
            <option value="out">Saída</option>
            <option value="initial" style="display:none;">Saldo Inicial</option>
          </select>
        </div>
        <div class="form-group">
          <label>Motivo</label>
          <textarea id="movementReason"></textarea>
        </div>
        <div style="text-align:right; margin-top:10px;">
          <button type="button" class="btn" onclick="closeModal()">Cancelar</button>
          <button type="submit" class="btn btn-success">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const apiToken = localStorage.getItem('api_token') || '';
    const metaCsrf = document.querySelector('meta[name="csrf-token"]');
    const csrfToken = metaCsrf ? metaCsrf.content : null;

    let movements = [];
    let products = [];
    let users = [];
    let usersLoaded = false;
    let productsLoaded = false;
    let movementsLoaded = false;

    function maybeRender() {
      const container = document.getElementById('movementsContainer');
      // se ambos carregaram, renderiza a tabela
      if (productsLoaded && movementsLoaded && usersLoaded) {
        renderTable();
        return true;
      }
      // se um dos dois ainda não carregou, mantém o loading
      container.innerHTML = '<div class="loading">Carregando movimentações e produtos...</div>';
      return false;
    }

    document.addEventListener('DOMContentLoaded', () => {
      // inicia ambos requests em paralelo; render ocorrera somente quando ambos responderem
      productsLoaded = false;
      movementsLoaded = false;
      usersLoaded = false;
      // mostra loading enquanto não tivermos ambos
      document.getElementById('movementsContainer').innerHTML = '<div class="loading">Carregando movimentações, produtos e usuários...</div>';
      loadMovements();
      loadProducts();
      loadUsers();
      // attach form submit handler
      document.getElementById('movementForm').addEventListener('submit', handleSave);
    });

    function loadProducts() {
      $.ajax({
        url: '/api/products', type: 'GET', dataType: 'json',
        headers: { 'Authorization': 'Bearer ' + apiToken, 'Accept': 'application/json', 'X-CSRF-Token': csrfToken },
        success: function (d) {
          products = d.products || [];
          populateProductSelect();
          productsLoaded = true;
          maybeRender();
        },
        error: function () {
          productsLoaded = false;
          document.getElementById('movementsContainer').innerHTML = '<p>Erro ao carregar produtos.</p>';
        }
      });
    }

    // popula o select de produtos no modal
    function populateProductSelect() {
      const sel = document.getElementById('movementProduct'); sel.innerHTML = '';
      products.forEach(p => {
        const o = document.createElement('option');
        o.value = p.id;
        o.textContent = p.name;
        o.dataset.name = p.name;
        o.dataset.current_stock = p.stock_qty;
        sel.appendChild(o);
      });
      // update product info display and listen for changes
      sel.removeEventListener('change', updateProductInfo);
      sel.addEventListener('change', updateProductInfo);
      updateProductInfo();
    }

    // atualiza a exibição das informações do produto selecionado (quando o usuário seleciona o produto, aparece o nome e o id dele)
    function updateProductInfo() {
      const sel = document.getElementById('movementProduct');
      const info = document.getElementById('productInfo');
      const nameEl = document.getElementById('productInfoName');
      const idEl = document.getElementById('productInfoId');
      const currentStockEl = document.getElementById('productInfoCurrentStock');

      if (!sel || sel.options.length === 0) {
        info.style.display = 'none';
        return;
      }

      const opt = sel.options[sel.selectedIndex];

      if (!opt) {
        info.style.display = 'none';
        return;
      }

      const name = opt.dataset.name || opt.textContent || '';
      const id = opt.value || '';
      nameEl.textContent = name;
      idEl.textContent = `ID: ${id}`;
      currentStockEl.textContent = `Estoque Atual: ${opt.dataset.current_stock || '0'}`;
      info.style.display = 'flex';
    }

    function loadUsers() {
      $.ajax({
        url: '/api/users', type: 'GET', dataType: 'json',
        headers: { 'Authorization': 'Bearer ' + apiToken, 'Accept': 'application/json', 'X-CSRF-Token': csrfToken },
        success: function (d) {
          users = d.users || [];
          usersLoaded = true;
          maybeRender();
        },
        error: function () {
          usersLoaded = false;
          document.getElementById('movementsContainer').innerHTML = '<p>Erro ao carregar usuários.</p>';
        }
      });
    }

    function loadMovements() {
      const container = document.getElementById('movementsContainer');
      container.innerHTML = '<div class="loading">Carregando movimentações...</div>';
      $.ajax({
        url: '/api/stock-movements', type: 'GET', dataType: 'json', headers: { 'Authorization': 'Bearer ' + apiToken, 'Accept': 'application/json', 'X-CSRF-Token': csrfToken },
        success: function (d) { movements = d.stock_movements || []; movementsLoaded = true; maybeRender(); },
        error: function (xhr) { movementsLoaded = false; container.innerHTML = '<p>Erro ao carregar movimentações.</p>'; }
      });
    }

    function renderTable() {
      const container = document.getElementById('movementsContainer');
      if (movements.length === 0) { container.innerHTML = '<p>Nenhuma movimentação registrada.</p>'; return; }
      let html = '<table><thead><tr><th>ID</th><th>Produto</th><th>Qtd</th><th>Tipo</th><th>Motivo</th><th>Criação</th><th>Atualização</th><th>Ações</th></tr></thead><tbody>';
      movements.forEach(m => {
        const prodLabel = resolveProductLabel(m.product_id);
        const userCreatedByLabel = resolveUserLabel(m.created_by);
        const userUpdatedByLabel = resolveUserLabel(m.updated_by);
        const tagClass = m.movement_type === 'in' ? 'tag-in' : 'tag-out';
        const typeLabel = m.movement_type === 'in' ? 'Entrada' : 'Saída';
        const typeTag = `<span class="movement-tag ${tagClass}">${typeLabel}</span>`;

        // Determina se a movimentação já foi atualizada
        const wasUpdated = (() => {
          // Se não existir updated_by ou updated_at/formatado, consideramos NÃO atualizada
          if (!m.updated_by) return false;
          if (!m.updated_at && !m.formatted_updated_at) return false;
          // Se created_at e updated_at existirem e forem iguais => não houve atualização
          if (m.created_at && m.updated_at && m.created_at === m.updated_at) return false;
          return true;
        })();

        const createdCell =
          `<strong>${escapeHtml(userCreatedByLabel || '-')}</strong> - ${m.formatted_created_at || ''}`;

        const updatedCell = wasUpdated
          ? `<strong>${escapeHtml(userUpdatedByLabel || '-')}</strong> - ${m.formatted_updated_at || ''}`
          : `<span class="movement-tag" style="background:#fff3cd;color:#856404;border:1px solid #ffeeba;">Não atualizada</span>`;

        html += `
        <tr>
          <td>${m.id}</td>
          <td>${escapeHtml(prodLabel)}</td>
          <td>${m.quantity}</td>
          <td>${typeTag}</td>
          <td>${escapeHtml(m.reason || '-')}</td>
          <td>${createdCell}</td>
          <td>${updatedCell}</td>
          <td>
            <button class="btn" onclick="openEdit(${m.id})">Editar</button>
            <button class="btn btn-danger" onclick="deleteMovement(${m.id})">Deletar</button>
          </td>
        </tr>`;
      });
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    function resolveProductLabel(productId) {
      if (!products || products.length === 0) return `#${productId}`;
      const p = products.find(x => String(x.id) === String(productId));
      if (!p) return `#${productId}`;
      return `${p.name}`;
    }

    function resolveUserLabel(userId) {
      if (!users || users.length === 0) return `#${userId}`;
      const u = users.find(x => String(x.id) === String(userId));
      // retorno caso a movimentação não tenha sido editada ainda
      if (u == null) return userId;
      if (!u) return `#${userId}`;
      return `${u.name}`;
    }

    function openCreateModal() {
      document.getElementById('movementForm').reset();
      document.getElementById('movementId').value = '';
      document.getElementById('modalTitle').textContent = 'Nova Movimentação';
      document.getElementById('movementModal').classList.add('active');
    }
    function closeModal() {
      document.getElementById('movementModal').classList.remove('active');
    }

    function openEdit(id) {
      fetch('/api/stock-movements/edit/' + id, { headers: { 'Authorization': 'Bearer ' + apiToken, 'Accept': 'application/json', 'X-CSRF-Token': csrfToken } })
        .then(r => r.json()).then(data => {
          if (data.error) { showAlert('Erro: ' + data.error, 'danger'); return; }
          const m = data.stock_movement;
          document.getElementById('movementId').value = m.id;
          document.getElementById('movementProduct').value = m.product_id;
          document.getElementById('movementQuantity').value = m.quantity;
          document.getElementById('movementType').value = m.movement_type;
          document.getElementById('movementReason').value = m.reason || '';
          document.getElementById('modalTitle').textContent = 'Editar Movimentação';
          // ensure product info updates
          updateProductInfo();
          document.getElementById('movementModal').classList.add('active');
        }).catch(() => showAlert('Erro ao buscar movimentação', 'danger'));
    }

    function handleSave(e) {
      e.preventDefault();
      const id = document.getElementById('movementId').value;
      const productId = parseInt(document.getElementById('movementProduct').value);
      const quantity = parseInt(document.getElementById('movementQuantity').value);
      const movement_type = document.getElementById('movementType').value;
      const reason = document.getElementById('movementReason').value;

      // Validações básicas no cliente
      if (!productId || isNaN(productId)) {
        showAlert('Selecione um produto válido', 'danger');
        return;
      }

      if (!quantity || isNaN(quantity) || quantity <= 0) {
        showAlert('Quantidade deve ser um valor positivo', 'danger');
        return;
      }

      if (!movement_type) {
        showAlert('Selecione um tipo de movimentação', 'danger');
        return;
      }

      const data = { product_id: productId, quantity: quantity, movement_type: movement_type, reason: reason };
      const url = id ? `/api/stock-movements/update/${id}` : '/api/stock-movements/create';
      const method = id ? 'PUT' : 'POST';
      $.ajax({
        url: url, type: method, contentType: 'application/json', data: JSON.stringify(data), headers: { 'Authorization': 'Bearer ' + apiToken, 'Accept': 'application/json', 'X-CSRF-Token': csrfToken },
        success: function () { showAlert('Movimentação salva com sucesso', 'success'); closeModal(); loadMovements(); loadProducts();},
        error: function (xhr) {
          let msg = 'Erro ao salvar';
          try {
            const j = JSON.parse(xhr.responseText);
            if (j.error) msg = j.error;
          } catch { }
          showAlert(msg, 'danger');
        }
      });
    }

    function deleteMovement(id) {
      if (!confirm('Confirmar exclusão?'))
        return;

      $.ajax({
        url: `/api/stock-movements/delete/${id}`,
        type: 'DELETE',
        headers: { 'Authorization': 'Bearer ' + apiToken, 'Accept': 'application/json', 'X-CSRF-Token': csrfToken },
        success: function () {
          showAlert('Movimentação deletada', 'success');
          loadMovements();
        }, error:
          function (xhr) {
            let msg = 'Erro ao deletar';
            try {
              const j = JSON.parse(xhr.responseText);
              if (j.error) msg = j.error;
            } catch {

            } showAlert(msg, 'danger');
          }
      });
    }


    function showAlert(message, type = 'info') {
      const alertsContainer = document.getElementById('alerts');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.textContent = message;
      alertsContainer.appendChild(alert);

      setTimeout(() => {
        alert.remove();
      }, 5000);
    }

    function showModalAlert(modalId, message, type = 'danger') {
      const alertContainer = document.getElementById(modalId);
      if (!alertContainer) return;
      alertContainer.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
      setTimeout(() => {
        alertContainer.innerHTML = '';
      }, 5000);
    }


    function escapeHtml(text) { if (!text) return ''; const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }; return String(text).replace(/[&<>"']/g, m => map[m]); }

    window.onclick = function (e) { const modal = document.getElementById('movementModal'); if (e.target === modal) closeModal(); }
  </script>
</body>

</html>